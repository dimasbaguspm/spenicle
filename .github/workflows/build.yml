name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start Docker services
        run: |
          cp .env.example .env
          docker compose -f docker-compose.yaml up --build -d

      - name: Run smoke checks
        run: |
          echo "Waiting for services to become ready"
          for i in {1..30}; do
            if curl -sS http://localhost:3000/ >/dev/null; then
              echo "web up"
              break
            fi
            echo "attempt $i: web not ready yet"
            sleep 2
          done

          echo "Running smoke checks"
          curl -f http://localhost:3000/
          curl -f http://localhost:3000/openapi.yaml || true

      - name: Teardown (docker-compose)
        if: always()
        run: |
          docker compose -f docker-compose.yaml logs --no-color || true
          docker compose -f docker-compose.yaml down -v || true
