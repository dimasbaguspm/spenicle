name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    env:
      DB_HOST: spenicle-postgres
      DB_PORT: "5432"
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: spenicle_test
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin
      JWT_SECRET: ci-test-secret
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start Docker services
        working-directory: scripts
        run: |
          echo "DB_HOST=${DB_HOST}" > .env
          echo "DB_PORT=${DB_PORT}" >> .env
          echo "DB_USER=${DB_USER}" >> .env
          echo "DB_PASSWORD=${DB_PASSWORD}" >> .env
          echo "DB_NAME=${DB_NAME}" >> .env
          echo "ADMIN_USERNAME=${ADMIN_USERNAME}" >> .env
          echo "ADMIN_PASSWORD=${ADMIN_PASSWORD}" >> .env
          echo "JWT_SECRET=${JWT_SECRET}" >> .env

          docker compose -f docker-compose.build.yaml up --build -d

      - name: Run smoke checks
        run: |
          echo "Waiting for services to become ready"
          for i in {1..30}; do
            if curl -sS http://localhost:3000/ >/dev/null; then
              echo "web up"
              break
            fi
            echo "attempt $i: web not ready yet"
            sleep 2
          done

          echo "Running smoke checks"
          curl -f http://localhost:3000/
          curl -f http://localhost:3000/openapi.yaml || true

      - name: Teardown (docker-compose)
        if: ${{ always() }}
        run: |
          docker compose -f example/docker-compose.yaml logs --no-color || true
          docker compose -f example/docker-compose.yaml down -v || true
